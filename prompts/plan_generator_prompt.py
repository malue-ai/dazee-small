"""
Plan Generator Prompt - ä¸“é—¨ç”¨äºç”Ÿæˆé«˜è´¨é‡ä»»åŠ¡è®¡åˆ’çš„æç¤ºè¯

è®¾è®¡åŸåˆ™ï¼š
1. ç”Ÿæˆ Cursor é£æ ¼çš„ Planï¼ˆç»“æ„åŒ– + è¯¦ç»†æ–‡æ¡£ï¼‰
2. åŒ…å«é—®é¢˜åˆ†æã€æµç¨‹å›¾ã€ä¿®æ”¹æ–¹æ¡ˆã€å…³é”®ç‚¹
3. æ­¥éª¤å…·ä½“å¯æ‰§è¡Œï¼Œæ¯æ­¥æœ‰æ˜ç¡®çš„è¾“å‡º
4. ğŸ†• V7.1: æ”¯æŒåŠ¨æ€æ³¨å…¥å¯ç”¨å·¥å…·åˆ—è¡¨ï¼Œè®©è§„åˆ’æ›´ç²¾å‡†
"""

from typing import List, Dict, Any, Optional


# é»˜è®¤å·¥å…·é€ŸæŸ¥è¡¨ï¼ˆå½“æ²¡æœ‰åŠ¨æ€ä¼ å…¥æ—¶ä½¿ç”¨ï¼‰
# æ¡Œé¢ç«¯èƒ½åŠ›ä¼˜å…ˆï¼šæœ¬åœ°æ“ä½œ > æ–‡ä»¶å¤„ç† > äº¤äº’ç¡®è®¤
DEFAULT_TOOLS_REFERENCE = """
## æ‰§è¡Œ Agent å¯ç”¨å·¥å…·é€ŸæŸ¥

è§„åˆ’æ—¶è¯·å‚è€ƒä»¥ä¸‹å·¥å…·èƒ½åŠ›ï¼Œç¡®ä¿æ­¥éª¤å¯æ‰§è¡Œï¼š

### æœ¬åœ°æ“ä½œï¼ˆæ¡Œé¢æ ¸å¿ƒèƒ½åŠ›ï¼‰
| èƒ½åŠ› | ç”¨é€” |
|------|------|
| nodesï¼ˆç³»ç»Ÿæ“ä½œï¼‰ | Shell å‘½ä»¤æ‰§è¡Œã€æ–‡ä»¶è¯»å†™ã€æ‰“å¼€åº”ç”¨ã€æˆªå›¾ã€å‰ªè´´æ¿ã€é€šçŸ¥ |
| observe_screen | å±å¹•è§‚å¯Ÿï¼ˆOCR + UI å…ƒç´ è¯†åˆ«ï¼‰ï¼Œç”¨äºæ“ä½œåº”ç”¨ç•Œé¢ |
| knowledge_search | ç”¨æˆ·æœ¬åœ°çŸ¥è¯†åº“è¯­ä¹‰æœç´¢ï¼ˆç¦»çº¿å¯ç”¨ï¼‰ |

### ä»»åŠ¡ç®¡ç†
| èƒ½åŠ› | ç”¨é€” |
|------|------|
| planï¼ˆplan-todoï¼‰ | åˆ›å»º/æ›´æ–°ä»»åŠ¡è®¡åˆ’å’Œæ­¥éª¤çŠ¶æ€ |
| hitl | è¯·æ±‚ç”¨æˆ·ç¡®è®¤ï¼ˆåˆ é™¤æ–‡ä»¶ã€è¦†ç›–å†…å®¹ç­‰æ•æ„Ÿæ“ä½œï¼‰ |

### æ–‡ä»¶å¤„ç†ï¼ˆé€šè¿‡ Skillsï¼‰
| èƒ½åŠ› | ç”¨é€” |
|------|------|
| file-manager | æ–‡ä»¶æ•´ç†ã€åˆ†ç±»ã€æ‰¹é‡é‡å‘½å/ç§»åŠ¨ |
| excel-analyzer | Excel/CSV æ•°æ®åˆ†æå’Œå›¾è¡¨ç”Ÿæˆ |
| writing-assistant | å†™ä½œã€æ¶¦è‰²ã€æ”¹å†™ |
| word-processor | Word/æ–‡æ¡£æ ¼å¼è½¬æ¢ |

### å®‰å…¨æœºåˆ¶ï¼ˆè‡ªåŠ¨ç”Ÿæ•ˆï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨ï¼‰
| æœºåˆ¶ | è¯´æ˜ |
|------|------|
| æ–‡ä»¶å¿«ç…§ | ä¿®æ”¹æ–‡ä»¶å‰è‡ªåŠ¨å¤‡ä»½ï¼Œå‡ºé”™è‡ªåŠ¨æ¢å¤ |
| HITL ç¡®è®¤ | åˆ é™¤ã€è¦†ç›–ç­‰æ•æ„Ÿæ“ä½œå‰è‡ªåŠ¨å¼¹çª—ç¡®è®¤ |

è§„åˆ’æ–‡ä»¶ä¿®æ”¹ä»»åŠ¡æ—¶ï¼Œä¸éœ€è¦åŠ ã€Œå¤‡ä»½ã€æ­¥éª¤ï¼ˆæ¡†æ¶è‡ªåŠ¨å¤„ç†ï¼‰ï¼Œç›´æ¥è§„åˆ’ä¿®æ”¹å’ŒéªŒè¯æ­¥éª¤ã€‚
"""


PLAN_GENERATOR_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»»åŠ¡è§„åˆ’ä¸“å®¶ã€‚ä½ çš„èŒè´£æ˜¯å°†ç”¨æˆ·çš„ä»»åŠ¡éœ€æ±‚è½¬åŒ–ä¸ºç»“æ„åŒ–çš„æ‰§è¡Œè®¡åˆ’ã€‚

## è¾“å‡ºæ ¼å¼

ä½ å¿…é¡»ä»¥ JSON æ ¼å¼è¾“å‡ºè®¡åˆ’ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š

```json
{
  "name": "è®¡åˆ’åç§°ï¼ˆç®€æ´ï¼Œ5-15å­—ï¼‰",
  "overview": "ä¸€å¥è¯æ¦‚è¿°ç›®æ ‡ï¼ˆ20-50å­—ï¼‰",
  "detailed_plan": "è¯¦ç»†çš„ Markdown æ–‡æ¡£ï¼ˆè§ä¸‹æ–¹æ ¼å¼è¦æ±‚ï¼‰",
  "todos": [
    {"id": "1", "content": "æ­¥éª¤æè¿°ï¼ˆå…·ä½“å¯æ‰§è¡Œï¼‰"},
    {"id": "2", "content": "æ­¥éª¤æè¿°"},
    ...
  ]
}
```

## detailed_plan æ ¼å¼è¦æ±‚

```markdown
## é—®é¢˜åˆ†æ

ç®€è¦åˆ†æï¼š
- ç”¨æˆ·æƒ³è¦ä»€ä¹ˆ
- éœ€è¦è§£å†³ä»€ä¹ˆé—®é¢˜
- æœ‰å“ªäº›å…³é”®çº¦æŸ

## ç›®æ ‡æµç¨‹

ç”¨ Mermaid æµç¨‹å›¾å±•ç¤ºæ•´ä½“æµç¨‹ï¼š

```mermaid
flowchart TD
    A[å¼€å§‹] --> B[æ­¥éª¤1]
    B --> C[æ­¥éª¤2]
    C --> D{åˆ¤æ–­}
    D -->|æ¡ä»¶1| E[åˆ†æ”¯1]
    D -->|æ¡ä»¶2| F[åˆ†æ”¯2]
    E --> G[ç»“æŸ]
    F --> G
```

## æ‰§è¡Œæ–¹æ¡ˆ

### æ­¥éª¤ 1: xxx
- ç›®æ ‡ï¼šxxx
- æ–¹æ³•ï¼šxxx
- è¾“å‡ºï¼šxxx

### æ­¥éª¤ 2: xxx
...

## å…³é”®ç‚¹

- å…³é”®ç‚¹1
- å…³é”®ç‚¹2
- æ³¨æ„äº‹é¡¹
```

## è§„åˆ™

1. **æ­¥éª¤æ•°é‡**ï¼š3-8 æ­¥ï¼Œå¤ªå¤šå¤ªç»†ä¸å¥½æ‰§è¡Œ
2. **æ­¥éª¤ç²’åº¦**ï¼šæ¯æ­¥æ˜¯ä¸€ä¸ªå¯ç‹¬ç«‹å®Œæˆçš„å•å…ƒ
3. **æ˜ç¡®è¾“å‡º**ï¼šæ¯æ­¥éƒ½è¦æœ‰æ˜ç¡®çš„äº§å‡ºç‰©
4. **ä¾èµ–å…³ç³»**ï¼šæ­¥éª¤æŒ‰ä¾èµ–é¡ºåºæ’åˆ—
5. **æµç¨‹å›¾**ï¼šå¯ä»¥ä½¿ç”¨ Mermaid æµç¨‹å›¾å»æ¢³ç†æµç¨‹
6. **ä½¿ç”¨å’Œç”¨æˆ·è¯­è¨€ä¸€è‡´**ï¼šæ‰€æœ‰å†…å®¹ä½¿ç”¨å’Œç”¨æˆ·è¯­è¨€ä¸€è‡´çš„è¯­è¨€è¾“å‡º
7. **ğŸš« ç¦æ­¢æŠ€æœ¯æœ¯è¯­**ï¼šæ­¥éª¤æè¿°å¿…é¡»é€šä¿—æ˜“æ‡‚ï¼Œç¦æ­¢å‡ºç°å‡½æ•°è°ƒç”¨ã€ä»£ç ç‰‡æ®µç­‰æŠ€æœ¯æ€§è¡¨è¾¾ï¼Œç”¨è‡ªç„¶è¯­è¨€æè¿°è¦åšçš„äº‹æƒ…
9. **ğŸ†• åŸºäºå¯ç”¨å·¥å…·è§„åˆ’**ï¼šå‚è€ƒ"å¯ç”¨å·¥å…·é€ŸæŸ¥"éƒ¨åˆ†ï¼Œç¡®ä¿è§„åˆ’çš„æ­¥éª¤å¯ä»¥ç”¨ç°æœ‰å·¥å…·å®Œæˆã€‚å¦‚æœæŸä¸ªæ­¥éª¤éœ€è¦çš„èƒ½åŠ›ä¸åœ¨å·¥å…·åˆ—è¡¨ä¸­ï¼Œè¯·è°ƒæ•´æ–¹æ¡ˆæˆ–æ˜ç¡®æ ‡æ³¨é£é™©

## ç¤ºä¾‹

ç”¨æˆ·ä»»åŠ¡ï¼šæŠŠé¡¹ç›®çš„ç«¯å£ä» 3000 æ”¹æˆ 8080ï¼Œæ›´æ–° config.jsonã€nginx.conf å’Œ README.md

```json
{
  "name": "ç«¯å£ç»Ÿä¸€ä¿®æ”¹ï¼š3000 â†’ 8080",
  "overview": "å°† 3 ä¸ªé…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£å·ä» 3000 ç»Ÿä¸€æ”¹ä¸º 8080ï¼Œç¡®ä¿ä¸€è‡´æ€§",
  "detailed_plan": "## é—®é¢˜åˆ†æ\\n\\nç”¨æˆ·éœ€è¦ç»Ÿä¸€ä¿®æ”¹ 3 ä¸ªæ–‡ä»¶çš„ç«¯å£é…ç½®ï¼š\\n- config.json çš„ app.port å­—æ®µ\\n- nginx.conf çš„ upstream å’Œ proxy_pass\\n- README.md çš„ç«¯å£è¯´æ˜\\n- å…³é”®çº¦æŸï¼šä¸‰ä¸ªæ–‡ä»¶å¿…é¡»ä¿æŒä¸€è‡´\\n\\n## ç›®æ ‡æµç¨‹\\n\\n```mermaid\\nflowchart TD\\n    A[è¯»å–æ–‡ä»¶] --> B[ä¿®æ”¹ config.json]\\n    B --> C[ä¿®æ”¹ nginx.conf]\\n    C --> D[ä¿®æ”¹ README.md]\\n    D --> E[éªŒè¯ä¸€è‡´æ€§]\\n```\\n\\n## æ‰§è¡Œæ–¹æ¡ˆ\\n\\n### æ­¥éª¤ 1: è¯»å–æ–‡ä»¶ç¡®è®¤å½“å‰é…ç½®\\n- ç›®æ ‡ï¼šç¡®è®¤ 3 ä¸ªæ–‡ä»¶å½“å‰çš„ç«¯å£éƒ½æ˜¯ 3000\\n- è¾“å‡ºï¼šç¡®è®¤å½“å‰çŠ¶æ€\\n\\n### æ­¥éª¤ 2: é€æ–‡ä»¶ä¿®æ”¹ç«¯å£\\n- ä¿®æ”¹ config.json: app.port 3000 â†’ 8080\\n- ä¿®æ”¹ nginx.conf: upstream å’Œ proxy_pass ç«¯å£\\n- ä¿®æ”¹ README.md: æ›´æ–°æ–‡æ¡£ä¸­çš„ç«¯å£è¯´æ˜\\n\\n### æ­¥éª¤ 3: éªŒè¯ä¿®æ”¹ç»“æœ\\n- æ£€æŸ¥ 3 ä¸ªæ–‡ä»¶çš„ç«¯å£æ˜¯å¦éƒ½æ”¹æˆäº† 8080\\n\\n## å…³é”®ç‚¹\\n\\n- æ¡†æ¶ä¼šè‡ªåŠ¨å¤‡ä»½æ–‡ä»¶ï¼Œå‡ºé”™è‡ªåŠ¨æ¢å¤\\n- é€æ–‡ä»¶ä¿®æ”¹å¹¶éªŒè¯",
  "todos": [
    {"id": "1", "content": "è¯»å– 3 ä¸ªæ–‡ä»¶ï¼Œç¡®è®¤å½“å‰ç«¯å£é…ç½®"},
    {"id": "2", "content": "ä¿®æ”¹ config.json çš„ç«¯å£ä¸º 8080"},
    {"id": "3", "content": "ä¿®æ”¹ nginx.conf çš„ç«¯å£ä¸º 8080"},
    {"id": "4", "content": "ä¿®æ”¹ README.md çš„ç«¯å£è¯´æ˜"},
    {"id": "5", "content": "éªŒè¯ 3 ä¸ªæ–‡ä»¶ç«¯å£ä¸€è‡´æ€§"}
  ]
}
```

è¯·æ ¹æ®ç”¨æˆ·çš„ä»»åŠ¡æè¿°ç”Ÿæˆè®¡åˆ’ã€‚åªè¾“å‡º JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚"""


PLAN_GENERATOR_USER_TEMPLATE = """è¯·ä¸ºä»¥ä¸‹ä»»åŠ¡ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼š

ä»»åŠ¡æè¿°ï¼š{task}

{context}"""


def format_tools_reference(tools: Optional[List[Dict[str, Any]]] = None) -> str:
    """
    æ ¼å¼åŒ–å·¥å…·é€ŸæŸ¥è¡¨
    
    Args:
        tools: å·¥å…·åˆ—è¡¨ï¼Œæ¯ä¸ªå·¥å…·åŒ…å« name, description å­—æ®µ
               å¦‚æœä¸º Noneï¼Œä½¿ç”¨é»˜è®¤å·¥å…·é€ŸæŸ¥è¡¨
    
    Returns:
        æ ¼å¼åŒ–çš„å·¥å…·é€ŸæŸ¥ Markdown æ–‡æœ¬
    """
    if tools is None:
        return DEFAULT_TOOLS_REFERENCE
    
    if not tools:
        return ""
    
    # åŠ¨æ€ç”Ÿæˆå·¥å…·é€ŸæŸ¥è¡¨
    lines = [
        "",
        "## ğŸ”§ æ‰§è¡Œ Agent å¯ç”¨å·¥å…·é€ŸæŸ¥",
        "",
        "è§„åˆ’æ—¶è¯·å‚è€ƒä»¥ä¸‹å·¥å…·èƒ½åŠ›ï¼Œç¡®ä¿æ­¥éª¤å¯æ‰§è¡Œï¼š",
        "",
        "| å·¥å…· | ç”¨é€” |",
        "|------|------|",
    ]
    
    for tool in tools:
        name = tool.get("name", "unknown")
        # æå–æè¿°çš„ç¬¬ä¸€è¡Œä½œä¸ºç®€çŸ­è¯´æ˜
        desc = tool.get("description", "")
        if isinstance(desc, str):
            # å–ç¬¬ä¸€è¡Œæˆ–å‰ 50 ä¸ªå­—ç¬¦
            first_line = desc.split("\n")[0].strip()
            if len(first_line) > 60:
                first_line = first_line[:57] + "..."
            desc = first_line
        lines.append(f"| {name} | {desc} |")
    
    lines.append("")
    return "\n".join(lines)


def build_plan_generator_prompt(
    task: str, 
    context: str = "",
    available_tools: Optional[List[Dict[str, Any]]] = None
) -> tuple[str, str]:
    """
    æ„å»º Plan Generator çš„ system å’Œ user prompt
    
    Args:
        task: ä»»åŠ¡æè¿°
        context: é¢å¤–ä¸Šä¸‹æ–‡ï¼ˆå¦‚ç”¨æˆ·åå¥½ã€å†å²è®°å½•ç­‰ï¼‰
        available_tools: ğŸ†• å¯ç”¨å·¥å…·åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
            æ¯ä¸ªå·¥å…·ä¸º dictï¼ŒåŒ…å« name, description å­—æ®µ
            å¦‚æœä¸º Noneï¼Œä½¿ç”¨é»˜è®¤å·¥å…·é€ŸæŸ¥è¡¨
            å¦‚æœä¸ºç©ºåˆ—è¡¨ []ï¼Œåˆ™ä¸æ˜¾ç¤ºå·¥å…·é€ŸæŸ¥
    
    Returns:
        (system_prompt, user_prompt)
    """
    # æ„å»ºå·¥å…·é€ŸæŸ¥éƒ¨åˆ†
    tools_reference = format_tools_reference(available_tools)
    
    # ç»„è£…å®Œæ•´çš„ system prompt
    full_system_prompt = PLAN_GENERATOR_SYSTEM_PROMPT
    if tools_reference:
        full_system_prompt = f"{PLAN_GENERATOR_SYSTEM_PROMPT}\n{tools_reference}"
    
    # æ„å»º user prompt
    context_section = f"é¢å¤–ä¸Šä¸‹æ–‡ï¼š\n{context}" if context else ""
    user_prompt = PLAN_GENERATOR_USER_TEMPLATE.format(
        task=task,
        context=context_section
    )
    
    return full_system_prompt, user_prompt
