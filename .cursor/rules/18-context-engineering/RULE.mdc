---
description: ä¸Šä¸‹æ–‡å·¥ç¨‹æé™ä¼˜åŒ–è§„èŒƒã€‚é€‚ç”¨äºæ‰€æœ‰æ¶‰åŠ LLM ä¸Šä¸‹æ–‡æ„å»ºã€å¤šæ¨¡æ€æ•°æ®å¤„ç†ã€å·¥å…·ç»“æœå¤„ç†ã€Skill/Agent è®¾è®¡çš„åœºæ™¯ã€‚
globs:
  - core/context/**
  - core/agent/**
  - core/prompt/**
  - core/memory/**
  - core/knowledge/**
  - utils/file_processor.py
  - utils/file_handler.py
  - tools/**
  - skills/**
  - instances/*/skills/**
  - prompts/**
alwaysApply: true
---

# ä¸Šä¸‹æ–‡å·¥ç¨‹æé™ä¼˜åŒ–è§„èŒƒï¼ˆå¼ºåˆ¶ï¼‰

## æ ¸å¿ƒå“²å­¦ï¼šæ–‡ä»¶ä¸ºåª’ä»‹ï¼Œæ–‡å­—äº¤æ¢ä¸ºä¸»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                 â”‚
â”‚  ğŸ§  ä¸Šä¸‹æ–‡çª—å£ = æœ€æ˜‚è´µçš„è®¤çŸ¥ç©ºé—´ï¼Œæ¯ä¸€ä¸ª token éƒ½å¿…é¡»ã€Œå€¼å¾—ã€                    â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  åŸåˆ™ 1: ä¸Šä¸‹æ–‡åªè£…ã€Œå†³ç­–æ‰€éœ€çš„æœ€å°ä¿¡æ¯ã€                                  â”‚    â”‚
â”‚  â”‚  åŸåˆ™ 2: é•¿å†…å®¹/å¤šæ¨¡æ€æ•°æ®é€šè¿‡ä¸´æ—¶æ–‡ä»¶äº¤æ¢ï¼Œä»£ç è´Ÿè´£è¯»å†™                    â”‚    â”‚
â”‚  â”‚  åŸåˆ™ 3: ä¼˜å…ˆæ–‡å­—æ‘˜è¦ï¼Œè€ŒéåŸå§‹æ•°æ®                                        â”‚    â”‚
â”‚  â”‚  åŸåˆ™ 4: åˆ†å±‚åŠ è½½ â€” å…ˆæ‘˜è¦ï¼ŒæŒ‰éœ€å±•å¼€                                       â”‚    â”‚
â”‚  â”‚  åŸåˆ™ 5: å·²å®Œæˆå­ä»»åŠ¡çš„ä¸­é—´è¿‡ç¨‹å¯æŠ˜å ï¼Œåªä¿ç•™ç»“è®º                            â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                 â”‚
â”‚  âŒ æŠŠ 50KB æ–‡æœ¬å…¨å¡è¿› user message                                              â”‚
â”‚  âŒ æŠŠå®Œæ•´æœç´¢ç»“æœ JSON æ”¾è¿› tool_result                                          â”‚
â”‚  âŒ æŠŠå›¾ç‰‡ base64 å’ŒåŸå§‹åƒç´ æ•°æ®ç•™åœ¨å†å²æ¶ˆæ¯                                       â”‚
â”‚  âŒ æŠŠå‰ 20 è½®å·¥å…·è°ƒç”¨çš„å®Œæ•´è¾“å…¥è¾“å‡ºä¿ç•™åœ¨ä¸Šä¸‹æ–‡                                    â”‚
â”‚                                                                                 â”‚
â”‚  âœ… 50KB æ–‡æœ¬ â†’ å†™å…¥ä¸´æ—¶æ–‡ä»¶ â†’ ä¸Šä¸‹æ–‡åªæ”¾ã€Œæ–‡ä»¶è·¯å¾„ + 500 å­—æ‘˜è¦ã€                 â”‚
â”‚  âœ… æœç´¢ç»“æœ â†’ ä»£ç æå– top-5 æ¡ç›® â†’ ä¸Šä¸‹æ–‡åªæ”¾æ ‡é¢˜+æ‘˜è¦                           â”‚
â”‚  âœ… å›¾ç‰‡ â†’ URL å¼•ç”¨ + 200 å­—æ–‡å­—æè¿°ï¼ˆå¦‚æœå·²ç»å¤„ç†è¿‡ï¼‰                              â”‚
â”‚  âœ… æ—§è½®æ¬¡å·¥å…·ç»“æœ â†’ æŠ˜å ä¸ºã€Œå·¥å…·å + ç»“è®ºä¸€å¥è¯ã€                                  â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸€ã€æ•°æ®åˆ†å±‚æ¨¡å‹ï¼ˆå¼ºåˆ¶ï¼‰

æ‰€æœ‰è¿›å…¥ LLM ä¸Šä¸‹æ–‡çš„æ•°æ®å¿…é¡»æŒ‰ä»¥ä¸‹ä¸‰å±‚åˆ†ç±»å¤„ç†ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 0: ä¸Šä¸‹æ–‡å±‚ï¼ˆContext Windowï¼‰              â”‚
â”‚  â”€â”€ ç›´æ¥å‡ºç°åœ¨ messages ä¸­ â”€â”€                     â”‚
â”‚  â€¢ ç³»ç»Ÿæç¤ºè¯ï¼ˆç¼“å­˜ç¨³å®šï¼‰                         â”‚
â”‚  â€¢ ç”¨æˆ·å½“å‰æŸ¥è¯¢                                   â”‚
â”‚  â€¢ æ‘˜è¦/ç»“è®ºï¼ˆâ‰¤ 500 tokens per itemï¼‰             â”‚
â”‚  â€¢ æ–‡ä»¶è·¯å¾„å¼•ç”¨                                   â”‚
â”‚  â€¢ å½“å‰è®¡åˆ’çŠ¶æ€                                   â”‚
â”‚  â€¢ æœ€è¿‘ 1-2 è½®å·¥å…·ç»“æœï¼ˆå®Œæ•´ï¼‰                     â”‚
â”‚  ç›®æ ‡ï¼šæ€»é‡æ§åˆ¶åœ¨ token_budget Ã— 70% ä»¥å†…          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 1: å·¥ä½œæ–‡ä»¶å±‚ï¼ˆScratchpad Filesï¼‰           â”‚
â”‚  â”€â”€ ä¸´æ—¶æ–‡ä»¶ï¼ŒAgent å¯æŒ‰éœ€è¯»å– â”€â”€                  â”‚
â”‚  â€¢ å·¥å…·å®Œæ•´è¾“å‡ºï¼ˆJSON/æ–‡æœ¬ï¼‰                       â”‚
â”‚  â€¢ ä¸‹è½½çš„æ–‡æ¡£/ç½‘é¡µå†…å®¹                             â”‚
â”‚  â€¢ ä¸­é—´è®¡ç®—ç»“æœ                                   â”‚
â”‚  â€¢ æœç´¢ç»“æœåŸå§‹æ•°æ®                               â”‚
â”‚  å­˜å‚¨ä½ç½®ï¼šworkspace/scratchpad/{session_id}/     â”‚
â”‚  ç”Ÿå‘½å‘¨æœŸï¼šä¼šè¯ç»“æŸåå¯æ¸…ç†                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 2: æŒä¹…å­˜å‚¨å±‚ï¼ˆPersistent Storageï¼‰         â”‚
â”‚  â”€â”€ æ•°æ®åº“/æ–‡ä»¶ç³»ç»Ÿï¼Œè·¨ä¼šè¯æŒä¹… â”€â”€                  â”‚
â”‚  â€¢ çŸ¥è¯†åº“ç´¢å¼•ï¼ˆFTS5/å‘é‡ï¼‰                         â”‚
â”‚  â€¢ ç”¨æˆ·è®°å¿†ï¼ˆMEMORY.mdï¼‰                           â”‚
â”‚  â€¢ Playbook ç­–ç•¥åº“                                â”‚
â”‚  â€¢ å†å²å¯¹è¯å­˜æ¡£                                   â”‚
â”‚  å­˜å‚¨ä½ç½®ï¼šdata/instances/{name}/                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€å¤šæ¨¡æ€æ•°æ®å¤„ç†ï¼ˆå¼ºåˆ¶ï¼‰

### æ€»åŸåˆ™ï¼šå¤šæ¨¡æ€ â†’ æ–‡å­—æè¿° + æ–‡ä»¶å¼•ç”¨

| æ•°æ®ç±»å‹ | ä¸Šä¸‹æ–‡å†…æ”¾ä»€ä¹ˆ | å®Œæ•´æ•°æ®å­˜å“ªé‡Œ |
|---|---|---|
| **å›¾ç‰‡** | URL å¼•ç”¨ï¼ˆClaude åŸç”Ÿæ”¯æŒï¼‰ï¼›å†å²è½®æ¬¡å›¾ç‰‡ â†’ æ›¿æ¢ä¸ºæ–‡å­—æè¿° | åŸå§‹ URL / æœ¬åœ°ç¼“å­˜ |
| **è§†é¢‘** | æ–‡å­—æè¿°ï¼ˆæ—¶é•¿/å†…å®¹æ¦‚è¦ï¼‰+ æ–‡ä»¶è·¯å¾„ | æœ¬åœ°æ–‡ä»¶ / URL |
| **éŸ³é¢‘** | è½¬å½•æ–‡å­—æ‘˜è¦ + æ–‡ä»¶è·¯å¾„ | æœ¬åœ°æ–‡ä»¶ |
| **PDF/æ–‡æ¡£** | é¦–æ®µæ‘˜è¦ï¼ˆâ‰¤ 500å­—ï¼‰+ æ–‡ä»¶è·¯å¾„ + é¡µæ•°/å¤§å° | æœ¬åœ°æ–‡ä»¶ / URL |
| **è¡¨æ ¼/CSV** | åˆ—å + å‰ 5 è¡Œ + ç»Ÿè®¡æ‘˜è¦ + æ–‡ä»¶è·¯å¾„ | æœ¬åœ°æ–‡ä»¶ |
| **ä»£ç æ–‡ä»¶** | æ ¸å¿ƒå‡½æ•°ç­¾å + æ–‡ä»¶è·¯å¾„ + è¡Œæ•° | æœ¬åœ°æ–‡ä»¶ |
| **ç½‘é¡µ** | æ ‡é¢˜ + æ ¸å¿ƒæ®µè½æ‘˜è¦ + URL | scratchpad æ–‡ä»¶ |

### å›¾ç‰‡å¤„ç†è§„åˆ™

```python
# âœ… æ­£ç¡®ï¼šå½“å‰è½®æ¬¡å›¾ç‰‡ä½¿ç”¨ URL å¼•ç”¨ï¼ˆClaude åŸç”Ÿæ”¯æŒï¼Œé«˜æ•ˆï¼‰
content_block = {"type": "image", "source": {"type": "url", "url": image_url}}

# âœ… æ­£ç¡®ï¼šå†å²è½®æ¬¡ï¼ˆ> 2 è½®å‰ï¼‰çš„å›¾ç‰‡æ›¿æ¢ä¸ºæ–‡å­—æè¿°
# _strip_old_images() å·²å®ç°ï¼Œä½†æ›¿æ¢å†…å®¹åº”æ›´æœ‰ä»·å€¼
old_image_replacement = {
    "type": "text",
    "text": f"[å›¾ç‰‡: {filename}, ç”¨æˆ·åœ¨ç¬¬ {turn} è½®ä¸Šä¼ ï¼Œå†…å®¹ä¸º{description}]"
}

# âŒ é”™è¯¯ï¼šæ‰€æœ‰å†å²å›¾ç‰‡ä¿ç•™ base64/URL
# âŒ é”™è¯¯ï¼šå›¾ç‰‡ä¸åšä»»ä½•æè¿°å°±ç›´æ¥ä¸¢å¼ƒ
```

### æ–‡æœ¬æ–‡ä»¶å¤„ç†è§„åˆ™ï¼ˆå…³é”®ä¼˜åŒ–ç‚¹ï¼‰

```python
# âŒ é”™è¯¯ï¼š50KB æ–‡æœ¬å…¨éƒ¨å¡è¿›æ¶ˆæ¯
text_content = await download_file(url)  # 50KB
message = f"æ–‡ä»¶å†…å®¹ï¼š\n{text_content}"  # å…¨éƒ¨å¡è¿›ä¸Šä¸‹æ–‡

# âœ… æ­£ç¡®ï¼šå¤§æ–‡æœ¬å†™å…¥ scratchpadï¼Œä¸Šä¸‹æ–‡åªæ”¾æ‘˜è¦ + è·¯å¾„
async def process_large_text(content: str, filename: str, session_id: str) -> str:
    """å¤„ç†å¤§æ–‡æœ¬æ–‡ä»¶ï¼šå†™å…¥ scratchpadï¼Œè¿”å›ä¸Šä¸‹æ–‡æ‘˜è¦"""
    if len(content) <= 2000:  # â‰¤ 2000 å­—ç¬¦ç›´æ¥æ”¾å…¥ä¸Šä¸‹æ–‡
        return content
    
    # å†™å…¥ scratchpad æ–‡ä»¶
    scratchpad_path = f"workspace/scratchpad/{session_id}/{filename}"
    await write_scratchpad(scratchpad_path, content)
    
    # ç”Ÿæˆä¸Šä¸‹æ–‡æ‘˜è¦
    preview = content[:500]  # å‰ 500 å­—ç¬¦é¢„è§ˆ
    return (
        f"ğŸ“„ æ–‡ä»¶: {filename} ({len(content)} å­—ç¬¦)\n"
        f"å®Œæ•´å†…å®¹: {scratchpad_path}\n"
        f"é¢„è§ˆ:\n{preview}\n...\n"
        f"ğŸ’¡ ä½¿ç”¨ cat {scratchpad_path} æŸ¥çœ‹å®Œæ•´å†…å®¹"
    )
```

**æ–‡æœ¬å¤§å°åˆ†çº§å¤„ç†**ï¼š

| æ–‡æœ¬å¤§å° | å¤„ç†æ–¹å¼ |
|---|---|
| â‰¤ 2KB | ç›´æ¥æ”¾å…¥ä¸Šä¸‹æ–‡ï¼ˆçº¦ 500 tokensï¼‰ |
| 2KB - 10KB | å‰ 500 å­— + å°¾ 200 å­— + scratchpad æ–‡ä»¶è·¯å¾„ |
| 10KB - 50KB | LLM ç”Ÿæˆæ‘˜è¦ï¼ˆâ‰¤ 500 å­—ï¼‰+ scratchpad æ–‡ä»¶è·¯å¾„ |
| > 50KB | ä»…æ–‡ä»¶è·¯å¾„ + å…ƒæ•°æ®ï¼ˆå¤§å°/ç±»å‹/è¡Œæ•°ï¼‰ï¼ŒAgent æŒ‰éœ€ cat ç‰‡æ®µ |

### æœç´¢ç»“æœå¤„ç†è§„åˆ™

```python
# âŒ é”™è¯¯ï¼šå®Œæ•´æœç´¢ç»“æœ JSON ç›´æ¥è¿”å›
tool_result = json.dumps(search_response)  # å¯èƒ½ 10000+ å­—ç¬¦

# âœ… æ­£ç¡®ï¼šä»£ç å±‚æå–å…³é”®ä¿¡æ¯ï¼Œä¸Šä¸‹æ–‡åªæ”¾ç²¾å
def extract_search_summary(raw_results: List[Dict], top_k: int = 5) -> str:
    """ä»æœç´¢ç»“æœæå–ç²¾åæ‘˜è¦"""
    summaries = []
    for item in raw_results[:top_k]:
        summaries.append(
            f"- [{item['title']}]({item['url']})\n"
            f"  {item['snippet'][:200]}"
        )
    
    # å®Œæ•´ç»“æœå†™å…¥ scratchpad
    save_to_scratchpad(raw_results)
    
    return f"æœç´¢åˆ° {len(raw_results)} æ¡ç»“æœï¼ŒTop {top_k}:\n" + "\n".join(summaries)
```

---

## ä¸‰ã€å·¥å…·ç»“æœå‹ç¼©ç­–ç•¥ï¼ˆå¼ºåˆ¶ï¼‰

### å³æ—¶å‹ç¼©ï¼ˆå½“å‰è½®æ¬¡ï¼‰

å·¥å…·æ‰§è¡Œå®Œæ¯•åï¼Œç«‹å³å†³å®šå‹ç¼©ç­–ç•¥ï¼š

| å·¥å…·ç±»å‹ | å‹ç¼©ç­–ç•¥ | ä¸Šä¸‹æ–‡ä¿ç•™ |
|---|---|---|
| æœç´¢ç±»ï¼ˆweb_search/exaï¼‰ | æå– top-5 æ‘˜è¦ | â‰¤ 2000 å­—ç¬¦ |
| æ–‡ä»¶è¯»å–ï¼ˆcat/readï¼‰ | ä¿ç•™é¦–å°¾ + scratchpad | â‰¤ 1000 å­—ç¬¦ |
| ä»£ç æ‰§è¡Œ | stdout/stderr å‰ 50 è¡Œ + scratchpad | â‰¤ 1500 å­—ç¬¦ |
| API è°ƒç”¨ | å…³é”®å­—æ®µæå– | â‰¤ 1000 å­—ç¬¦ |
| åˆ—è¡¨/æšä¸¾ | å‰ 10 æ¡ + æ€»æ•° | â‰¤ 500 å­—ç¬¦ |

### å†å²è½®æ¬¡æŠ˜å ï¼ˆContext Foldingï¼‰

å·²å®Œæˆçš„å·¥å…·è°ƒç”¨é“¾ï¼ŒæŠ˜å ä¸ºä¸€å¥è¯ç»“è®ºï¼š

```python
# âœ… æ­£ç¡®ï¼šæ—§è½®æ¬¡ tool_result æŠ˜å 
# åŸå§‹ï¼ˆ3 è½®å‰ï¼‰ï¼š
#   tool_use: web_search("Python æ’åºç®—æ³•")
#   tool_result: {"results": [...5000 å­—ç¬¦...]}
#
# æŠ˜å åï¼š
#   "[ç¬¬ 3 è½®] web_search â†’ æ‰¾åˆ° 8 æ¡ç»“æœï¼Œæœ€ç›¸å…³ï¼šå¿«é€Ÿæ’åº O(nlogn)ã€å½’å¹¶æ’åºã€TimSort"

def fold_old_tool_result(tool_name: str, result: str, turn: int) -> str:
    """å°†æ—§è½®æ¬¡å·¥å…·ç»“æœæŠ˜å ä¸ºä¸€å¥è¯"""
    # æ–¹æ¡ˆ Aï¼šä»£ç è§„åˆ™æå–ï¼ˆâ‰¤ 100 å­—ç¬¦ç»“è®ºï¼‰
    if len(result) <= 200:
        return result  # çŸ­ç»“æœä¸æŠ˜å 
    
    conclusion = extract_conclusion(result)  # ä»£ç æå–ç»“è®º
    return f"[ç¬¬{turn}è½®] {tool_name} â†’ {conclusion}"
```

### å‹ç¼©é˜ˆå€¼ï¼ˆè°ƒä¼˜åï¼‰

```python
# å½“å‰è½®æ¬¡ï¼šå®Œæ•´ä¿ç•™
CURRENT_TURN_THRESHOLD = float('inf')

# æœ€è¿‘ 2 è½®ï¼šé€‚åº¦å‹ç¼©ï¼ˆä¿ç•™å¤´å°¾ + scratchpad å¼•ç”¨ï¼‰
RECENT_TURNS_THRESHOLD = 3000  # å­—ç¬¦

# æ›´æ—©è½®æ¬¡ï¼šæ¿€è¿›å‹ç¼©ï¼ˆä»…ä¿ç•™ç»“è®ºï¼‰
OLD_TURNS_THRESHOLD = 200  # å­—ç¬¦
```

---

## å››ã€Scratchpad æ–‡ä»¶äº¤æ¢æœºåˆ¶ï¼ˆå¼ºåˆ¶ï¼‰

### è®¾è®¡åŸåˆ™

Scratchpad æ˜¯ LLM ä¸Šä¸‹æ–‡å’Œå¤§æ•°æ®ä¹‹é—´çš„ã€Œç¼“å†²åŒºã€ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     å†™å…¥æ‘˜è¦      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     æŒ‰éœ€ cat      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tool     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  LLM Context  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚  Scratchpad   â”‚
â”‚  æ‰§è¡Œç»“æœ  â”‚     (â‰¤500å­—)    â”‚  (ç²¾ç®€é«˜æ•ˆ)    â”‚   (éœ€è¦è¯¦æƒ…æ—¶)    â”‚  Files        â”‚
â”‚  (10KB+)  â”‚                 â”‚               â”‚                  â”‚  (å®Œæ•´æ•°æ®)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                                 â†‘
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å®Œæ•´æ•°æ®å†™å…¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç›®å½•ç»“æ„

```
workspace/
â”œâ”€â”€ scratchpad/
â”‚   â””â”€â”€ {session_id}/
â”‚       â”œâ”€â”€ search_001.json        # æœç´¢ç»“æœå®Œæ•´æ•°æ®
â”‚       â”œâ”€â”€ file_content_002.txt   # ä¸‹è½½çš„æ–‡ä»¶å†…å®¹
â”‚       â”œâ”€â”€ api_response_003.json  # API è°ƒç”¨å®Œæ•´å“åº”
â”‚       â””â”€â”€ _index.json            # æ–‡ä»¶ç´¢å¼•ï¼ˆåç§°â†’ç”¨é€”æ˜ å°„ï¼‰
â”‚
â”œâ”€â”€ storage/
â”‚   â””â”€â”€ tool_results/              # å·²æœ‰çš„å·¥å…·ç»“æœå‹ç¼©å­˜å‚¨
â”‚       â””â”€â”€ {ref_id}.json
```

### ä½¿ç”¨è§„èŒƒ

```python
# âœ… Skill å¼€å‘è§„èŒƒï¼šå¤§æ•°æ®å¿…é¡»èµ° scratchpad
async def my_skill_execute(params: dict, context: RuntimeContext) -> str:
    result = await heavy_operation()
    
    if len(str(result)) > 2000:
        # å†™å…¥ scratchpad
        path = await context.write_scratchpad(
            filename="result.json",
            content=json.dumps(result, ensure_ascii=False)
        )
        # è¿”å›æ‘˜è¦ + è·¯å¾„
        return (
            f"å¤„ç†å®Œæˆï¼Œå…± {len(result)} æ¡æ•°æ®ã€‚\n"
            f"å…³é”®å‘ç°ï¼š{extract_key_findings(result)}\n"
            f"å®Œæ•´æ•°æ®ï¼š{path}"
        )
    
    return str(result)
```

---

## äº”ã€ä¸Šä¸‹æ–‡æ³¨å…¥é¢„ç®—æ§åˆ¶ï¼ˆå¼ºåˆ¶ï¼‰

### æ¯ç±»æ³¨å…¥æºçš„ Token é¢„ç®—

| æ³¨å…¥æº | æœ€å¤§ Token | è¯´æ˜ |
|---|---|---|
| ç³»ç»Ÿè§’è‰²æç¤ºè¯ | 2000 | ç¼“å­˜ç¨³å®šï¼Œä¸€æ¬¡æ€§å¼€é”€ |
| å·¥å…·å®šä¹‰ | 3000 | ç¼“å­˜ç¨³å®š |
| è®°å¿†å¬å›ï¼ˆMemoryï¼‰ | 500 | ä»… top-3 æ¡æœ€ç›¸å…³è®°å¿† |
| Playbook ç­–ç•¥ | 300 | ä»…æœ€åŒ¹é…çš„ 1 æ¡ç­–ç•¥æ‘˜è¦ |
| çŸ¥è¯†æ£€ç´¢ï¼ˆKnowledgeï¼‰ | 800 | top-3 snippet + å¼•ç”¨è·¯å¾„ |
| å†å²æ‘˜è¦ | 500 | å‹ç¼©åçš„å¯¹è¯å†å² |
| Plan/Todo çŠ¶æ€ | 300 | å½“å‰ç›®æ ‡ + è¿›åº¦ |
| Skill æç¤ºè¯ï¼ˆåŠ¨æ€ï¼‰ | 1000 | å½“å‰æ¿€æ´» Skill çš„æŒ‡ä»¤ |
| **å•ä¸ª tool_result** | **3000** | **è¶…å‡ºå†™ scratchpad** |
| **åˆè®¡ï¼ˆéæ¶ˆæ¯éƒ¨åˆ†ï¼‰** | **â‰¤ 12000** | **çº¦å  200K é¢„ç®—çš„ 6%** |

### Injector å¿…é¡»éµå®ˆé¢„ç®—

```python
# âœ… æ­£ç¡®ï¼šInjector å†…éƒ¨æˆªæ–­åˆ°é¢„ç®—
class UserMemoryInjector:
    MAX_TOKENS = 500
    
    async def inject(self, context) -> str:
        memories = await recall(query, top_k=5)
        # ä»æœ€ç›¸å…³çš„å¼€å§‹ï¼Œç´¯è®¡ token ç›´åˆ°é¢„ç®—
        result = []
        token_count = 0
        for mem in memories:
            mem_tokens = count_tokens(mem.content)
            if token_count + mem_tokens > self.MAX_TOKENS:
                break
            result.append(mem.content)
            token_count += mem_tokens
        return "\n".join(result)

# âŒ é”™è¯¯ï¼šInjector ä¸æ§åˆ¶è¾“å‡ºå¤§å°
class BadInjector:
    async def inject(self, context) -> str:
        return await get_all_memories()  # å¯èƒ½è¿”å› 5000 tokens
```

---

## å…­ã€Skill è®¾è®¡ä¸­çš„ä¸Šä¸‹æ–‡è§„èŒƒï¼ˆå¼ºåˆ¶ï¼‰

æ‰€æœ‰ Skill å¿…é¡»éµå®ˆä»¥ä¸‹ä¸Šä¸‹æ–‡çºªå¾‹ï¼š

### 6.1 è¾“å…¥å¤„ç†

```yaml
# SKILL.md ä¸­å¿…é¡»å£°æ˜è¾“å…¥å¤„ç†ç­–ç•¥
input_handling:
  max_context_input: 2000  # Skill ä»ä¸Šä¸‹æ–‡æ¥æ”¶çš„æœ€å¤§å­—ç¬¦æ•°
  large_input_strategy: "scratchpad"  # file / scratchpad / chunked
  supported_formats:
    - text: "inline"        # â‰¤ 2KB ç›´æ¥æ¥æ”¶
    - image: "url_ref"      # URL å¼•ç”¨
    - document: "file_path" # æ–‡ä»¶è·¯å¾„
```

### 6.2 è¾“å‡ºå¤„ç†

```yaml
# SKILL.md ä¸­å¿…é¡»å£°æ˜è¾“å‡ºå¤„ç†ç­–ç•¥
output_handling:
  max_context_output: 3000  # Skill è¿”å›åˆ°ä¸Šä¸‹æ–‡çš„æœ€å¤§å­—ç¬¦æ•°
  large_output_strategy: "scratchpad_with_summary"
  # å¯é€‰ç­–ç•¥ï¼š
  # - "truncate": æˆªæ–­åˆ° max_context_output
  # - "scratchpad_with_summary": å®Œæ•´æ•°æ®å†™ scratchpadï¼Œè¿”å›æ‘˜è¦
  # - "streaming": æµå¼åˆ†å—è¿”å›
```

### 6.3 Skill è¾“å‡ºç¤ºä¾‹

```python
# âœ… æ­£ç¡®ï¼šSkill è¾“å‡ºæ§åˆ¶
class ExcelAnalyzerSkill:
    async def execute(self, file_path: str) -> str:
        df = pd.read_csv(file_path)
        
        # å®Œæ•´åˆ†æç»“æœå†™ scratchpad
        full_analysis = self.analyze(df)
        scratchpad_path = await self.save_scratchpad(full_analysis)
        
        # ä¸Šä¸‹æ–‡åªè¿”å›æ‘˜è¦
        return (
            f"## Excel åˆ†æå®Œæˆ\n"
            f"- è¡Œæ•°: {len(df)}, åˆ—æ•°: {len(df.columns)}\n"
            f"- åˆ—: {', '.join(df.columns[:10])}\n"
            f"- å…³é”®ç»Ÿè®¡:\n{df.describe().to_string()[:500]}\n"
            f"\nå®Œæ•´åˆ†æ: {scratchpad_path}"
        )

# âŒ é”™è¯¯ï¼šSkill è¿”å›å®Œæ•´ DataFrame
class BadExcelSkill:
    async def execute(self, file_path: str) -> str:
        df = pd.read_csv(file_path)
        return df.to_string()  # å¯èƒ½ 100KB+
```

---

## ä¸ƒã€å¯¹è¯å†å²å‹ç¼©ç­–ç•¥ï¼ˆå¢å¼ºï¼‰

### 7.1 æ¸è¿›å¼æ¶ˆæ¯è¡°å‡

```
æ—¶é—´è½´: â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ å½“å‰
æ¶ˆæ¯:    M1  M2  M3  M4 ... M15  M16  M17  M18  M19  M20

å¤„ç†:    [â”€â”€â”€â”€â”€â”€ æ‘˜è¦åŒº â”€â”€â”€â”€â”€â”€]  [â”€â”€ æŠ˜å åŒº â”€â”€]  [â”€â”€ å®Œæ•´åŒº â”€â”€]
         LLM æ‘˜è¦(â‰¤500 tokens)  å¤´å°¾å‹ç¼©        åŸæ–‡ä¿ç•™

         M1-M10 â†’ ä¸€æ®µæ‘˜è¦      M11-M16 æŠ˜å     M17-M20 å®Œæ•´
                                 tool_result
                                 â†’ ä¸€å¥è¯ç»“è®º
```

### 7.2 å›¾ç‰‡è‡ªåŠ¨è¡°å‡ï¼ˆå·²å®ç°ï¼Œéœ€å¢å¼ºï¼‰

```python
# å½“å‰ï¼š_strip_old_images() æ›¿æ¢ä¸º "[å›¾ç‰‡å·²çœç•¥]"
# ä¼˜åŒ–ï¼šæ›¿æ¢ä¸ºæœ‰æ„ä¹‰çš„æ–‡å­—æè¿°

async def decay_old_image(image_block: dict, turn: int) -> dict:
    """å›¾ç‰‡è¡°å‡ï¼šURL â†’ æ–‡å­—æè¿°"""
    # å¦‚æœä¹‹å‰ LLM å·²ç»æè¿°è¿‡è¿™å¼ å›¾ç‰‡ï¼ˆåœ¨ assistant å›å¤ä¸­ï¼‰ï¼Œ
    # æå–é‚£æ®µæè¿°ä½œä¸ºæ›¿æ¢æ–‡æœ¬
    description = extract_image_description_from_history(turn)
    
    if description:
        return {"type": "text", "text": f"[å›¾ç‰‡@ç¬¬{turn}è½®: {description}]"}
    
    return {"type": "text", "text": f"[å›¾ç‰‡@ç¬¬{turn}è½®: ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡]"}
```

### 7.3 å·¥å…·å¯¹ï¼ˆtool_use + tool_resultï¼‰æŠ˜å 

```python
# è¶…è¿‡ N è½®çš„å·¥å…·å¯¹ï¼ŒæŠ˜å ä¸ºå•è¡Œæ‘˜è¦
def fold_tool_pair(tool_use: dict, tool_result: dict, turn: int) -> str:
    tool_name = tool_use.get("name", "unknown")
    
    # æå– tool_result çš„ç»“è®º
    result_text = extract_text(tool_result)
    if len(result_text) > 150:
        conclusion = result_text[:100] + "..."
    else:
        conclusion = result_text
    
    return f"[T{turn}] {tool_name} â†’ {conclusion}"
```

---

## å…«ã€è¡Œä¸šæœ€ä½³å®è·µèåˆ

### 8.1 Context Foldingï¼ˆä¸Šä¸‹æ–‡æŠ˜å ï¼‰

å€Ÿé‰´ AgentFold è®ºæ–‡ï¼ˆ2025ï¼‰ï¼Œå®ç°å­ä»»åŠ¡å®Œæˆåè‡ªåŠ¨æŠ˜å ï¼š

```
ä»»åŠ¡: è°ƒç ”ç«å“å¹¶å†™æŠ¥å‘Š

æ‰§è¡Œè¿‡ç¨‹:
  Branch 1: æœç´¢ç«å“ A
    â”œâ”€ web_search("ç«å“A åŠŸèƒ½") â†’ 8 æ¡ç»“æœ (5000 tokens)
    â”œâ”€ web_search("ç«å“A å®šä»·") â†’ 5 æ¡ç»“æœ (3000 tokens)
    â””â”€ Return: "ç«å“A: SaaSæ¨¡å¼, æ ¸å¿ƒåŠŸèƒ½X/Y/Z, å®šä»·$99/æœˆ" (50 tokens)
                                                          â†‘ æŠ˜å åä»…ä¿ç•™è¿™ä¸€è¡Œ
  Branch 2: æœç´¢ç«å“ B
    â””â”€ Return: "ç«å“B: å¼€æºæ¨¡å¼, åŠŸèƒ½P/Q, å…è´¹" (30 tokens)

  Main: å†™æŠ¥å‘Šï¼ˆåŸºäºæŠ˜å åçš„ç»“è®ºï¼‰
```

**æ•ˆæœ**ï¼šåŸå§‹ä¸Šä¸‹æ–‡ 8000+ tokens â†’ æŠ˜å å 80 tokensï¼ˆ100x å‹ç¼©ï¼‰

### 8.2 Cognitive Workspaceï¼ˆè®¤çŸ¥å·¥ä½œåŒºï¼‰

å€Ÿé‰´ Cognitive Workspace è®ºæ–‡ï¼ˆ2025ï¼‰ï¼Œå®ç°ä¸»åŠ¨è®°å¿†ç®¡ç†ï¼š

```python
# Agent ä¸»åŠ¨å†³å®šå“ªäº›ä¿¡æ¯å€¼å¾—ä¿ç•™åœ¨ä¸Šä¸‹æ–‡
# é€šè¿‡ System Prompt æŒ‡å¯¼ï¼š
MEMORY_GUIDANCE = """
ä½ æœ‰ä¸€ä¸ª scratchpad å·¥ä½œåŒºç”¨äºå­˜å‚¨ä¸­é—´ç»“æœã€‚
å½“å·¥å…·è¿”å›å¤§é‡æ•°æ®æ—¶ï¼š
1. æå–å…³é”®å‘ç°å†™å…¥ä½ çš„å›å¤
2. å®Œæ•´æ•°æ®å·²è‡ªåŠ¨ä¿å­˜åˆ° scratchpad
3. éœ€è¦è¯¦æƒ…æ—¶ä½¿ç”¨ cat å‘½ä»¤æŸ¥çœ‹ scratchpad æ–‡ä»¶
"""
```

### 8.3 Aconï¼ˆAgent Context Optimizationï¼‰

å€Ÿé‰´ Acon è®ºæ–‡ï¼ˆ2025ï¼‰ï¼Œå¯¹ç¯å¢ƒè§‚æµ‹å’Œäº¤äº’å†å²ç»Ÿä¸€å‹ç¼©ï¼š

- **ç¯å¢ƒè§‚æµ‹å‹ç¼©**ï¼šå·¥å…·ç»“æœã€æœç´¢ç»“æœã€æ–‡ä»¶å†…å®¹ â†’ æå–å†³ç­–ç›¸å…³ä¿¡æ¯
- **äº¤äº’å†å²å‹ç¼©**ï¼šæ—§è½®æ¬¡ â†’ æ‘˜è¦ï¼›å¤±è´¥è½®æ¬¡ â†’ ä¿ç•™æ•™è®­ï¼Œä¸¢å¼ƒç»†èŠ‚
- **è‡ªé€‚åº”å‹ç¼©**ï¼šæ ¹æ®ä»»åŠ¡å¤æ‚åº¦åŠ¨æ€è°ƒæ•´å‹ç¼©é˜ˆå€¼

---

## ä¹ã€ç¦æ­¢æ¨¡å¼

### âŒ ç¦æ­¢ï¼šå¤§æ•°æ®ç›´å¡ä¸Šä¸‹æ–‡

```python
# âŒ ä¸¥ç¦ï¼šæ–‡ä»¶å†…å®¹ç›´æ¥å¡è¿›æ¶ˆæ¯
content = await read_file(path)  # å¯èƒ½ 100KB
messages.append({"role": "user", "content": f"æ–‡ä»¶å†…å®¹:\n{content}"})

# âŒ ä¸¥ç¦ï¼šAPI å“åº”ä¸åšå¤„ç†ç›´æ¥è¿”å›
result = await api_call()
return json.dumps(result)  # å¯èƒ½ 20KB JSON

# âŒ ä¸¥ç¦ï¼šæœç´¢ç»“æœå…¨é‡è¿”å›
results = await web_search(query)
return str(results)  # æ‰€æœ‰ç»“æœ+å…ƒæ•°æ®
```

### âŒ ç¦æ­¢ï¼šå†å²æ¶ˆæ¯æ— é™å¢é•¿

```python
# âŒ ä¸¥ç¦ï¼šä¸åšä»»ä½•å‹ç¼©åœ°ä¼ é€’å®Œæ•´å†å²
messages = await load_all_messages(conversation_id)
response = await llm.create(messages=messages)  # å¯èƒ½ 100K+ tokens

# âŒ ä¸¥ç¦ï¼šä¿ç•™æ‰€æœ‰å†å²å›¾ç‰‡çš„ base64
# æ¯å¼ å›¾ç‰‡çº¦ 1000-5000 tokensï¼Œ10 å¼ å›¾ = 10K-50K tokens
```

### âŒ ç¦æ­¢ï¼šSkill è¾“å‡ºä¸å—æ§

```python
# âŒ ä¸¥ç¦ï¼šSkill è¿”å›ä¸é™å¤§å°çš„ç»“æœ
class BadSkill:
    async def execute(self) -> str:
        data = await process()
        return json.dumps(data)  # å¤§å°æœªçŸ¥ï¼Œå¯èƒ½çˆ†ä¸Šä¸‹æ–‡
```

---

## åã€æ£€æŸ¥æ¸…å•

### å¼€å‘æ—¶è‡ªæ£€

- [ ] ä»»ä½•å†™å…¥ä¸Šä¸‹æ–‡çš„æ•°æ®æ˜¯å¦è¶…è¿‡ 3000 å­—ç¬¦ï¼Ÿå¦‚æœæ˜¯ï¼Œæ˜¯å¦èµ°äº† scratchpadï¼Ÿ
- [ ] å·¥å…·ç»“æœæ˜¯å¦åšäº†æ‘˜è¦æå–ï¼Ÿè¿˜æ˜¯å…¨é‡è¿”å›ï¼Ÿ
- [ ] å›¾ç‰‡/è§†é¢‘/éŸ³é¢‘æ˜¯å¦è½¬ä¸ºæ–‡å­—æè¿° + æ–‡ä»¶å¼•ç”¨ï¼Ÿ
- [ ] Skill è¾“å‡ºæ˜¯å¦å£°æ˜äº† `max_context_output`ï¼Ÿ
- [ ] Injector æ˜¯å¦æœ‰ token é¢„ç®—æ§åˆ¶ï¼Ÿ
- [ ] å†å²æ¶ˆæ¯ä¸­æ—§çš„ tool_result æ˜¯å¦æŠ˜å ï¼Ÿ
- [ ] å¤§æ–‡ä»¶æ˜¯å¦åˆ†å±‚å¤„ç†ï¼ˆç›´æ¥/æ‘˜è¦/è·¯å¾„å¼•ç”¨ï¼‰ï¼Ÿ

### ä»£ç å®¡æŸ¥è¦ç‚¹

1. æœç´¢ `content = await` åæ˜¯å¦æœ‰å¤§å°æ£€æŸ¥
2. æœç´¢ `tool_result` ç›¸å…³ä»£ç æ˜¯å¦æœ‰å‹ç¼©é€»è¾‘
3. æœç´¢ `json.dumps` è¿”å›æ˜¯å¦æœ‰æˆªæ–­
4. æœç´¢ `message.append` æ˜¯å¦æœ‰ token æ§åˆ¶
5. ç¡®è®¤æ¯ä¸ª Skill çš„ `execute()` è¿”å›å€¼å¤§å°å¯æ§
6. ç¡®è®¤ Injector çš„ `inject()` æœ‰ MAX_TOKENS å¸¸é‡

---

## åä¸€ã€ä¸ç°æœ‰æ¨¡å—çš„åä½œå…³ç³»

```
æœ¬è§„èŒƒ                          ç°æœ‰æ¨¡å—
â”€â”€â”€â”€â”€â”€â”€â”€                        â”€â”€â”€â”€â”€â”€â”€â”€
æ•°æ®åˆ†å±‚æ¨¡å‹ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ core/context/compaction/ (L2 è£å‰ª)
                                core/context/compaction/tool_result.py (å·¥å…·å‹ç¼©)

Scratchpad æœºåˆ¶ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ workspace/storage/ (éƒ¨åˆ†å·²æœ‰)
                                utils/file_processor.py (æ–‡ä»¶å¤„ç†)

å¤šæ¨¡æ€å¤„ç† â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ utils/file_processor.py (å›¾ç‰‡/æ–‡æœ¬/æ–‡æ¡£åˆ†ç±»)
                                core/context/compaction/__init__.py (_strip_old_images)

æ³¨å…¥é¢„ç®—æ§åˆ¶ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ core/context/injectors/ (Phase æ³¨å…¥å™¨)
                                core/context/context_engineering.py (KV-Cache)

å¯¹è¯å†å²å‹ç¼© â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ core/context/compaction/ (trim/compress_with_summary)
                                core/context/compaction/summarizer.py (æ‘˜è¦ç”Ÿæˆ)

Skill ä¸Šä¸‹æ–‡çºªå¾‹ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ instances/*/skills/ (SKILL.md)
                                core/skill/dynamic_loader.py (Skill åŠ è½½)
```

---

## åäºŒã€å½“å‰æ¡†æ¶å·®è·åˆ†æä¸ä¼˜åŒ–è·¯å¾„

### å·²æœ‰ä¼˜åŠ¿ï¼ˆä¿æŒï¼‰

| èƒ½åŠ› | å®ç° | è¯„ä»· |
|---|---|---|
| å·¥å…·ç»“æœå‹ç¼© | `ToolResultCompressor` (5000 å­—ç¬¦é˜ˆå€¼) | è‰¯å¥½ï¼Œé˜ˆå€¼å¯è°ƒä½ |
| åŒé˜ˆå€¼æ¶ˆæ¯è£å‰ª | `trim_by_token_budget` / `compress_with_summary` | è‰¯å¥½ |
| æ—§ tool_result æˆªæ–­ | `_compress_old_tool_results` (head 200 + tail 100) | è‰¯å¥½ |
| KV-Cache ä¼˜åŒ– | `CacheOptimizer` (ç¨³å®š JSON åºåˆ—åŒ–) | è‰¯å¥½ |
| æ³¨å…¥å™¨åˆ†å±‚ | Phase 1/2/3 Injector ç³»ç»Ÿ | è‰¯å¥½ |

### éœ€è¦ä¼˜åŒ–ï¼ˆP0ï¼‰

| å·®è· | å½“å‰è¡Œä¸º | ç›®æ ‡è¡Œä¸º | æ¶‰åŠæ–‡ä»¶ |
|---|---|---|---|
| æ–‡æœ¬æ–‡ä»¶å…¨å¡ä¸Šä¸‹æ–‡ | â‰¤ 50KB å…¨éƒ¨åµŒå…¥æ¶ˆæ¯ | â‰¤ 2KB ç›´æ¥åµŒå…¥ï¼Œ> 2KB èµ° scratchpad | `utils/file_processor.py` |
| æœç´¢ç»“æœä¸åšæå– | å·¥å…·åŸæ ·è¿”å› JSON | ä»£ç å±‚ top-5 æå– + scratchpad | `tools/` ä¸­çš„æœç´¢å·¥å…· |
| Scratchpad æœºåˆ¶ç¼ºå¤± | ä»…æœ‰ tool_results å­˜å‚¨ | ç»Ÿä¸€ scratchpad ç›®å½• + RuntimeContext æ–¹æ³• | `core/context/runtime.py` |
| Injector æ— é¢„ç®—æ§åˆ¶ | æ³¨å…¥å¤§å°ä¸å—é™ | æ¯ä¸ª Injector å£°æ˜ MAX_TOKENS | `core/context/injectors/` |
| å†å²å›¾ç‰‡ç²—æš´ä¸¢å¼ƒ | æ›¿æ¢ä¸º "[å›¾ç‰‡å·²çœç•¥]" | æ›¿æ¢ä¸ºå›¾ç‰‡æè¿°æ–‡å­— | `core/context/compaction/` |

### éœ€è¦ä¼˜åŒ–ï¼ˆP1ï¼‰

| å·®è· | å½“å‰è¡Œä¸º | ç›®æ ‡è¡Œä¸º | æ¶‰åŠæ–‡ä»¶ |
|---|---|---|---|
| æ—  Context Folding | æ—§è½®æ¬¡ä»…æˆªæ–­ | å­ä»»åŠ¡å®ŒæˆåæŠ˜å ä¸ºç»“è®º | `core/context/compaction/` |
| Skill è¾“å‡ºä¸å—æ§ | æ— è¾“å‡ºå¤§å°çº¦æŸ | SKILL.md å£°æ˜ + è¿è¡Œæ—¶æˆªæ–­ | `core/skill/`, `instances/*/skills/` |
| å·¥å…·å‹ç¼©é˜ˆå€¼è¿‡é«˜ | 5000 å­—ç¬¦æ‰è§¦å‘ | 3000 å­—ç¬¦è§¦å‘å³æ—¶å‹ç¼© | `core/context/compaction/tool_result.py` |
| Memory å¬å›æ— é¢„ç®— | è¿”å›æ‰€æœ‰åŒ¹é…ç»“æœ | top-3 + 500 tokens ä¸Šé™ | `core/memory/instance_memory.py` |
