---
name: code-review
description: 按本仓库工程规范进行代码审查（LLM-First、异步 I/O、日志、品牌中立、架构分层与一致返回）。用于审查 PR、review git diff、定位潜在 bug/安全/性能问题并给出可执行修改建议时。
---

# code-review

## 适用场景（触发词）

- 审查 PR / 代码变更 / `git diff`
- 需要给出 **风险评估**、**可执行修改建议**、**测试计划**
- 需要检查是否违反本仓库强制规范（异步 I/O、日志、LLM-First、品牌中立等）

## 强约束（必须遵守）

- **LLM-First（强制）**：语义推断、复杂度判断、路由决策、能力推断必须交给模型；不要用关键词匹配/正则做语义判断
- **异步优先（强制）**：禁止阻塞 I/O（`requests` / `time.sleep` / `with open()` 等），外部调用必须有超时与错误处理
- **日志规范（强制）**：禁止 `print()`；错误日志必须带堆栈（`exc_info=True`）；不要记录敏感信息
- **品牌中立（强制）**：代码/注释/文档中不得出现竞品智能体框架与竞品 AI 产品名
- **意图识别唯一实现（强制）**：意图识别由路由层统一处理（`core/routing/intent_analyzer.py` 为唯一实现），不要在 Agent 内重复实现
- **敏感信息（强制）**：不得把 token/key 写入代码、日志或提交；不要提交 `config.yaml`（除非用户明确要求）

## 审查工作流（按顺序执行）

### 1) 先理解“为什么改”

- 变更目标是什么（修 bug / 新功能 / 重构 / 配置调整）？
- 影响面：后端/前端/配置/文档/测试 哪些要联动？

### 2) Correctness（正确性）

- 是否有明显逻辑错误、空指针/KeyError、边界条件缺失？
- 是否引入不一致的返回结构或异常处理路径？
- 是否有并发/竞态风险（重复请求、任务取消、过期响应覆盖）？

### 3) Security（安全）

- 是否可能泄露敏感信息（日志、返回体、异常信息、配置）？
- 是否存在输入校验不足、路径穿越、命令注入等风险？
- 对外调用是否做了超时、重试（如需要）、失败降级？

### 4) Performance（性能）

- 是否把重计算放在热路径？是否有可避免的重复 I/O？
- 是否存在不必要的全量遍历、无界缓存、无上限并发？
- 意图识别链路是否满足低时延约束（只保留必要上下文，不做额外 LLM/网络调用）？

### 5) Maintainability（可维护性）

- 是否遵循目录/分层约定（路由/服务/模型/工具）？
- 函数是否具备清晰边界与类型注解？是否过度耦合？
- 是否产生明显冗余（重复实现、未使用文件/对象）需要清理？

### 6) Docs & Tests（文档与测试）

- 破坏性变更是否同步更新文档（README/架构/配置说明）？
- 是否需要新增/更新测试？至少给出可复制的手动验证步骤

## 输出格式（必须使用以下模板）

```markdown
## 总览
- 目标：<1 句话>
- 风险：低/中/高（原因：<1 句话>）

## 必须修改（Blocking）
- [ ] <问题>（位置：`path:line`，影响：...，建议：...）

## 建议改进（Suggestion）
- <建议>（理由：...）

## 可选优化（Nice to have）
- <可选项>

## 测试计划
- [ ] <命令或手动步骤，可复制>
```

